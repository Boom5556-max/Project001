import { useState, useEffect } from "react";
import { API_BASE_URL } from "../api/config.js";

export const useCalendarData = (roomIdFromUrl) => {
  const [rooms, setRooms] = useState([]);
  const [selectedRoom, setSelectedRoom] = useState("");
  const [events, setEvents] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  // ดึงรายชื่อห้อง
  useEffect(() => {
    const fetchRooms = async () => {
      try {
        const res = await fetch(`${API_BASE_URL}/rooms/`, { headers: { "ngrok-skip-browser-warning": "true" } });
        const data = await res.json();
        if (data?.length > 0) {
          setRooms(data);
          setSelectedRoom(roomIdFromUrl || data[0].room_id);
        }
      } catch (err) { console.error(err); }
      finally { setIsLoading(false); }
    };
    fetchRooms();
  }, [roomIdFromUrl]);

  // ดึงข้อมูลตารางและคำขอจอง
  useEffect(() => {
    const fetchData = async () => {
      const token = localStorage.getItem("token");
      if (!selectedRoom || !token) return;

      const headers = { "ngrok-skip-browser-warning": "true", Authorization: `Bearer ${token}` };
      try {
        const [bookRes, schedRes] = await Promise.all([
          fetch(`${API_BASE_URL}/bookings/allBooking/${selectedRoom}?status=approved`, { headers }),
          fetch(`${API_BASE_URL}/schedule/${selectedRoom}`, { headers })
        ]);

        const bookingData = bookRes.ok ? await bookRes.json() : [];
        const scheduleData = schedRes.ok ? await schedRes.json() : { schedules: [] };

        // Formatting Logic ... (ยกมาจากโค้ดเดิมของนาย)
        const formattedEvents = [
            ...bookingData.map(b => ({ /* format booking */ })),
            ...(scheduleData.schedules || []).map(s => ({ /* format schedule */ }))
        ];
        setEvents(formattedEvents);
      } catch (err) { console.error(err); }
    };
    fetchData();
  }, [selectedRoom]);

  return { rooms, selectedRoom, setSelectedRoom, events, isLoading };
};